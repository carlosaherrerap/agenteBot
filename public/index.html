<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max - InformaPeru Cobranza Inteligente</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <header>
        <div class="container nav">
            <div class="logo-container">
                <div class="logo-icon">M</div>
                <div class="logo-text">
                    <h1>INFORMAPERU</h1>
                    <p>Max ü§ñAsistente de Cobranzas</p>
                </div>
            </div>
            <div class="nav-links">
                <button class="btn btn-primary" onclick="openModal()">
                    <i data-lucide="qr-code"></i> Conectar WhatsApp
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="hero">
            <div class="container hero-content">
                <div class="hero-text">
                    <h2>Cobranza inteligente, resultados reales</h2>
                    <p>Optimice su gesti√≥n de cobranzas con nuestro asistente virtual inteligente. Atenci√≥n 24/7 de
                        forma personalizada y eficiente.</p>
                    <div class="hero-btns">
                        <button class="btn btn-primary" onclick="openModal()">
                            <i data-lucide="message-square"></i> Iniciar Sesi√≥n con QR
                        </button>
                    </div>
                </div>
                <div class="hero-image">
                    <img src="hero.png" alt="Gesti√≥n de cobranza profesional">
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features">
            <div class="container">
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="cpu"></i></div>
                        <h3>Identificaci√≥n Inteligente</h3>
                        <p>Detecci√≥n autom√°tica de DNI, RUC y cuentas para una validaci√≥n inmediata y segura.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="clock"></i></div>
                        <h3>Atenci√≥n 24/7</h3>
                        <p>Su equipo de cobranzas nunca duerme. Respuestas instant√°neas en cualquier momento del d√≠a.
                        </p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="shield-check"></i></div>
                        <h3>Seguridad y Confianza</h3>
                        <p>Garant√≠a de privacidad y profesionalismo en cada interacci√≥n con sus clientes.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>InformaPeru ¬© 2026 - Conectando soluciones financieras de forma elegante y sutil.</p>
        </div>
    </footer>

    <!-- QR Connection Modal -->
    <div id="qrModal" class="modal-overlay">
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle">Conectar WhatsApp</h2>
            <p id="modalSubtitle">Escanea el c√≥digo para habilitar el asistente</p>

            <div class="qr-wrapper">
                <div id="qrPlaceholder" class="qr-placeholder"
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <svg class="spinner" width="40" height="40" viewBox="0 0 50 50">
                        <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5" stroke="#003366">
                        </circle>
                    </svg>
                    <p style="margin-top: 15px; font-size: 14px; color: #666;">Generando c√≥digo...</p>
                </div>
                <img id="qrImage" src="" alt="QR Code" style="display: none;">
            </div>

            <div id="stateConnecting" style="display: none;">
                <p class="success-text" style="color: var(--primary); font-weight: 600;">Verificando conexi√≥n...</p>
            </div>

            <div id="stateConnected" style="display: none;">
                <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
                <p style="color: var(--success); font-weight: 700;">¬°Conectado!</p>
                <p style="font-size: 13px; color: #666;">Redirigiendo al panel de control...</p>
            </div>

            <div class="status-bar">
                <div class="status-item" id="statusSQL">
                    <span class="status-dot"></span> SQL
                </div>
                <div class="status-item" id="statusRedis">
                    <span class="status-dot"></span> Redis
                </div>
                <div class="status-item" id="statusWA">
                    <span class="status-dot"></span> WA
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        const qrModal = document.getElementById('qrModal');
        const qrImage = document.getElementById('qrImage');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const stateConnecting = document.getElementById('stateConnecting');
        const stateConnected = document.getElementById('stateConnected');

        let currentState = 'disconnected';
        let isModalOpen = false;

        function openModal() {
            qrModal.style.display = 'flex';
            isModalOpen = true;
            checkStatus(); // Start polling
        }

        function closeModal() {
            qrModal.style.display = 'none';
            isModalOpen = false;
        }

        async function checkStatus() {
            if (!isModalOpen) return;

            try {
                const response = await fetch('/api/connection-status');
                const data = await response.json();

                updateStatusDot('statusSQL', data.sql);
                updateStatusDot('statusRedis', data.redis);
                updateStatusDot('statusWA', data.whatsapp);

                if (data.state === 'connected' || data.whatsapp) {
                    showConnected();
                    setTimeout(() => window.location.href = '/dashboard.html', 1500);
                } else if (data.state === 'connecting') {
                    showConnecting();
                } else if (data.state === 'qr' || data.state === 'disconnected') {
                    showQR();
                }

            } catch (err) {
                console.error('Error checking status:', err);
            }
        }

        function updateStatusDot(elementId, isConnected) {
            const element = document.getElementById(elementId);
            const dot = element.querySelector('.status-dot');
            if (isConnected) {
                dot.classList.add('connected');
                dot.classList.remove('disconnected');
            } else {
                dot.classList.remove('connected');
                dot.classList.add('disconnected');
            }
        }

        function showQR() {
            qrImage.style.display = 'block';
            qrPlaceholder.style.display = 'none';
            stateConnecting.style.display = 'none';
            stateConnected.style.display = 'none';

            // Auto refresh QR if empty or every 20s
            if (!qrImage.src.includes('qr')) {
                refreshQR();
            }
        }

        function showConnecting() {
            qrImage.style.display = 'none';
            qrPlaceholder.style.display = 'none';
            stateConnecting.style.display = 'block';
            stateConnected.style.display = 'none';
        }

        function showConnected() {
            qrImage.style.display = 'none';
            qrPlaceholder.style.display = 'none';
            stateConnecting.style.display = 'none';
            stateConnected.style.display = 'block';
        }

        function refreshQR() {
            if (isModalOpen && currentState !== 'connected') {
                qrImage.src = '/qr?' + new Date().getTime();
            }
        }

        setInterval(checkStatus, 2000);
        setInterval(refreshQR, 20000);
    </script>

    <style>
        /* Extra spinner for modal */
        .spinner {
            animation: rotate 2s linear infinite;
        }

        .path {
            stroke-dasharray: 1, 150;
            stroke-dashoffset: 0;
            stroke-linecap: round;
            animation: dash 1.5s ease-in-out infinite;
        }

        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes dash {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }

            50% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -35;
            }

            100% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -124;
            }
        }
    </style>
</body>

</html>